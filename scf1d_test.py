# -*- coding: utf-8 -*-
"""
Created on Mon Sep 15 21:08:34 2014

@author: Richard Sheridan

These tests were generated using the code as of 6/16/15.
No guarantee is made regarding absolute correctness, only that the results
haven't changed since that version.
"""

from __future__ import division, print_function
import numpy as np

from util import schultz_zimm
from scf1d import (SCFprofile, SCFsqueeze, BasicSystem, VaporSwollenSystem,
                   SCFsolve, SCFeqns, SCFeqns_multi, Propagator, NoConvergence)

g_zs_data=np.array((
   ( 0.90000000,  0.67833333,  0.53457407,  0.43538321,  0.36346252,
     0.30925318,  0.26714431,  0.23365571,  0.20652162,  0.18420452,
     0.16562391,  0.14999788,  0.13674637,  0.12542991,  0.11570948,
     0.10731936,  0.10004837,  0.0937266 ,  0.08821584,  0.08340252),
   ( 0.92222222,  0.85049383,  0.76425846,  0.68155058,  0.60783778,
     0.54394935,  0.4891275 ,  0.44218798,  0.40194363,  0.36734135,
     0.33749022,  0.31165092,  0.28921394,  0.26967689,  0.25262446,
     0.23771168,  0.22465053,  0.21319918,  0.20315348,  0.19434016),
   ( 0.94444444,  0.89197531,  0.84257659,  0.7930217 ,  0.74413393,
     0.69722471,  0.65323138,  0.61264733,  0.57563553,  0.54214957,
     0.5120236 ,  0.4850313 ,  0.46092225,  0.43944331,  0.42035059,
     0.4034157 ,  0.38842854,  0.37519809,  0.36355202,  0.3533357 ),
   ( 0.96666667,  0.93444444,  0.90345542,  0.87380169,  0.84505407,
     0.81709233,  0.79005942,  0.76420135,  0.73975859,  0.71691616,
     0.69579069,  0.67643584,  0.65885458,  0.64301244,  0.62884938,
     0.61628918,  0.6052467 ,  0.59563309,  0.58735937,  0.58033893),
   ( 0.98888889,  0.97790123,  0.96719845,  0.95693471,  0.94725739,
     0.93822305,  0.92984965,  0.92215235,  0.91515455,  0.90888661,
     0.90338093,  0.89866754,  0.89477117,  0.89170994,  0.88949506,
     0.88813126,  0.8876176 ,  0.88794842,  0.88911423,  0.89110265),
   ( 1.01111111,  1.02234568,  1.03387151,  1.04586384,  1.05850568,
     1.07179988,  1.08562363,  1.09981238,  1.11421611,  1.12872507,
     1.14327513,  1.1578427 ,  1.17243568,  1.18708411,  1.20183196,
     1.2167308 ,  1.23183506,  1.24719889,  1.26287398,  1.27890843),
   ( 1.03333333,  1.06777778,  1.10354047,  1.14085245,  1.17885107,
     1.21673962,  1.25401498,  1.29043   ,  1.32591   ,  1.36048312,
     1.39423345,  1.42727231,  1.45972146,  1.49170372,  1.52333786,
     1.55473604,  1.58600256,  1.6172335 ,  1.64851681,  1.67993261),
   ( 1.05555556,  1.11419753,  1.17627115,  1.23566805,  1.29102979,
     1.34261892,  1.39113583,  1.43729989,  1.48172328,  1.52489154,
     1.56717868,  1.60887008,  1.65018392,  1.69128862,  1.7323162 ,
     1.77337216,  1.81454277,  1.85590018,  1.8975062 ,  1.93941493),
   ( 1.07777778,  1.16160494,  1.21517227,  1.25496048,  1.28875838,
     1.32029364,  1.35135685,  1.38279751,  1.41500143,  1.44812428,
     1.48220808,  1.51724019,  1.55318343,  1.58999174,  1.62761807,
     1.66601842,  1.70515369,  1.74499047,  1.78550116,  1.82666377),
   ( 1.1       ,  1.00425926,  0.9494177 ,  0.91902123,  0.90402499,
     0.89922403,  0.90148479,  0.9088376 ,  0.91999378,  0.93407904,
     0.95048074,  0.96875736,  0.98858277,  1.00971099,  1.03195321,
     1.05516234,  1.07922242,  1.10404129,  1.1295452 ,  1.15567502)))

g_zs_ta_data = np.array((
       (  9.00000000e-01,   5.40000000e-01,   3.44750000e-01,
          2.32057407e-01,   1.63182762e-01,   1.18909613e-01,
          8.91942729e-02,   6.85112896e-02,   5.36702862e-02,
          4.27458873e-02,   3.45293323e-02,   2.82349142e-02,
          2.33361729e-02,   1.94708968e-02,   1.63840546e-02,
          1.38924051e-02,   1.18619166e-02,   1.01929871e-02,
          8.81054699e-03,   7.65729535e-03),
       (  0.00000000e+00,   1.38333333e-01,   1.68049383e-01,
          1.59655453e-01,   1.39999701e-01,   1.18990036e-01,
          9.99648391e-02,   8.37567498e-02,   7.02914374e-02,
          5.92119992e-02,   5.01154320e-02,   4.26348293e-02,
          3.64612874e-02,   3.13434433e-02,   2.70798154e-02,
          2.35098237e-02,   2.05055808e-02,   1.79650316e-02,
          1.58064477e-02,   1.39640932e-02),
       (  0.00000000e+00,   0.00000000e+00,   2.17746914e-02,
          4.01622085e-02,   5.09704753e-02,   5.55038957e-02,
          5.58698032e-02,   5.37794965e-02,   5.03986580e-02,
          4.64583240e-02,   4.23921664e-02,   3.84437829e-02,
          3.47398749e-02,   3.13372615e-02,   2.82521634e-02,
          2.54781029e-02,   2.29966886e-02,   2.07840162e-02,
          1.88143888e-02,   1.70624124e-02),
       (  0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
          3.50814472e-03,   8.73138241e-03,   1.39319543e-02,
          1.82139259e-02,   2.13049739e-02,   2.32609305e-02,
          2.42696439e-02,   2.45469939e-02,   2.42904207e-02,
          2.36629921e-02,   2.27918432e-02,   2.17724199e-02,
          2.06743749e-02,   1.95472967e-02,   1.84256090e-02,
          1.73324995e-02,   1.62829586e-02),
       (  0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
          0.00000000e+00,   5.78194222e-04,   1.82024107e-03,
          3.51226222e-03,   5.37879716e-03,   7.19678933e-03,
          8.82375170e-03,   1.01879864e-02,   1.12682785e-02,
          1.20747695e-02,   1.26345241e-02,   1.29818629e-02,
          1.31524460e-02,   1.31799736e-02,   1.30945794e-02,
          1.29222527e-02,   1.26848446e-02),
       (  0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
          0.00000000e+00,   0.00000000e+00,   9.74364337e-05,
          3.72423702e-04,   8.45750250e-04,   1.48928204e-03,
          2.25009829e-03,   3.07039056e-03,   3.89911195e-03,
          4.69684009e-03,   5.43641967e-03,   6.10148618e-03,
          6.68422006e-03,   7.18306621e-03,   7.60075285e-03,
          7.94271547e-03,   8.21591641e-03),
       (  0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
          0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
          1.67807191e-05,   7.56996886e-05,   1.98314090e-04,
          3.95755195e-04,   6.68038713e-04,   1.00663252e-03,
          1.39794287e-03,   1.82641850e-03,   2.27679495e-03,
          2.73546224e-03,   3.19113019e-03,   3.63500643e-03,
          4.06067510e-03,   4.46381663e-03),
       (  0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
          0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
          0.00000000e+00,   2.95216355e-06,   1.53949862e-05,
          4.58153916e-05,   1.02417597e-04,   1.91445606e-04,
          3.16399051e-04,   4.78006078e-04,   6.74663168e-04,
          9.03073979e-04,   1.15890201e-03,   1.43733487e-03,
          1.73351944e-03,   2.04286531e-03),
       (  0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
          0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
          0.00000000e+00,   0.00000000e+00,   5.30296046e-07,
          3.14642320e-06,   1.05080289e-05,   2.60638735e-05,
          5.35481090e-05,   9.64846722e-05,   1.57814991e-04,
          2.39684868e-04,   3.43375784e-04,   4.69343535e-04,
          6.17323631e-04,   7.86469082e-04),
       (  0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
          0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
          0.00000000e+00,   0.00000000e+00,   0.00000000e+00,
          9.72209417e-08,   6.48139611e-07,   2.40177435e-06,
          6.53967800e-06,   1.46129172e-05,   2.84049958e-05,
          4.97630787e-05,   8.04351502e-05,   1.21938004e-04,
          1.75467518e-04,   2.41852179e-04)))

def calc_g_zs_ta_test():
    layers=10
    segments=20
    g_z = np.linspace(.9,1.1,layers)
    g_zs = Propagator(g_z,segments)
    assert np.allclose(g_zs.ta(), g_zs_ta_data, atol=1e-14)


def calc_g_zs_ngts_u_test():
    layers=10
    segments=20
    g_z = np.linspace(.9,1.1,layers)
    c = 1.0
    g_zs = Propagator(g_z,segments)
    assert np.allclose(g_zs.ngts_u(c), g_zs_data, atol=1e-14)

def calc_g_zs_ngts_test():
    layers=10
    segments=20
    g_z = np.linspace(.9,1.1,layers)
    c_i = np.zeros(segments)
    c_i[-1]= 1.0
    g_zs = Propagator(g_z,segments)
    assert np.allclose(g_zs.ngts(c_i), g_zs_data, atol=1e-14)

def calc_g_zs_free_test():
    layers=10
    segments=20
    g_z = np.linspace(.9,1.1,layers)
    g_zs = Propagator(g_z,segments)
    assert np.allclose(g_zs.free(), g_zs_data, atol=1e-14)

def SCFeqns_test():

    # away from solution
    phi_z = np.linspace(.5,0,50)
    chi = 0.1
    chi_s = 0.05
    sigma = .1
    navgsegments = 95.5
    pdi = 1.2
    p_i = schultz_zimm(pdi,navgsegments)
    data = np.array([  4.56885753e+00,   1.27473567e+01,   1.29799866e+01,
         1.25941193e+01,   1.20030366e+01,   1.54353170e+00,
         8.20490367e-01,   5.85342697e-01,   4.84869467e-01,
         4.36478200e-01,   4.09949567e-01,   3.92782245e-01,
         3.79629333e-01,   3.68190711e-01,   3.57478065e-01,
         3.47068739e-01,   3.36783786e-01,   3.26548662e-01,
         3.16332987e-01,   3.06124696e-01,   2.95919128e-01,
         2.85714537e-01,   2.75510285e-01,   2.65306148e-01,
         2.55102048e-01,   2.44897961e-01,   2.34693878e-01,
         2.24489796e-01,   2.14285714e-01,   2.04081633e-01,
         1.93877551e-01,   1.83673469e-01,   1.73469388e-01,
         1.63265306e-01,   1.53061224e-01,   1.42857143e-01,
         1.32653061e-01,   1.22448980e-01,   1.12244898e-01,
         1.02040816e-01,   9.18367347e-02,   8.16326531e-02,
         7.14285714e-02,   6.12244898e-02,   5.10204082e-02,
         4.08163265e-02,   3.06122449e-02,   2.04081633e-02,
         1.02040816e-02,  -2.60349244e-25])
    result = SCFeqns(phi_z,chi,chi_s,sigma,navgsegments,p_i)

    assert np.allclose(result, data, atol=1e-14)

    # at solution
    phi_z = np.array([  3.65555778e-01,   3.97530942e-01,   3.95177593e-01,
         3.88755392e-01,   3.80784804e-01,   3.72128254e-01,
         3.63090353e-01,   3.53797489e-01,   3.44313620e-01,
         3.34678411e-01,   3.24920384e-01,   3.15062002e-01,
         3.05122091e-01,   2.95117245e-01,   2.85062724e-01,
         2.74973026e-01,   2.64862253e-01,   2.54744317e-01,
         2.44633057e-01,   2.34542304e-01,   2.24485900e-01,
         2.14477710e-01,   2.04531625e-01,   1.94661559e-01,
         1.84881453e-01,   1.75205269e-01,   1.65646998e-01,
         1.56220661e-01,   1.46940309e-01,   1.37820027e-01,
         1.28873934e-01,   1.20116183e-01,   1.11560959e-01,
         1.03222487e-01,   9.51150272e-02,   8.72528915e-02,
         7.96504609e-02,   7.23222205e-02,   6.52828140e-02,
         5.85471226e-02,   5.21303666e-02,   4.60482169e-02,
         4.03168798e-02,   3.49530831e-02,   2.99738486e-02,
         2.53958999e-02,   2.12345582e-02,   1.75020558e-02,
         1.42053630e-02,   1.13438569e-02,   8.90736329e-03,
         6.87516042e-03,   5.21636994e-03,   3.89180122e-03,
         2.85690535e-03,   2.06521082e-03,   1.47156065e-03,
         1.03463569e-03,   7.18524401e-04,   4.93361836e-04,
         3.35231541e-04,   2.25588058e-04,   1.50440247e-04,
         9.94770155e-05,   6.52498334e-05,   4.24697365e-05,
         2.74367658e-05,   1.75962019e-05,   1.12044893e-05,
         6.43768632e-07,   3.90023255e-07,   2.34559779e-07,
         1.40008161e-07,   8.29272726e-08,   4.87244589e-08,
         2.83845206e-08,   1.63805733e-08,   9.35038310e-09,
         5.26436221e-09,   2.90675760e-09,   1.55475537e-09,
         7.81883338e-10,   3.39857917e-10,   9.31247294e-11])
    data = np.array([  1.38858813e+00,   1.22712170e+01,   1.27152996e+01,
         1.25948180e+01,   1.21308339e+01,   2.77822712e+00,
         1.00037091e+00,   6.14461712e-01,   4.57514843e-01,
         3.84265846e-01,   3.46503169e-01,   3.24346931e-01,
         3.09058361e-01,   2.96756860e-01,   2.85731743e-01,
         2.75239734e-01,   2.64965933e-01,   2.54783573e-01,
         2.44647525e-01,   2.34547494e-01,   2.24487712e-01,
         2.14478326e-01,   2.04531829e-01,   1.94661625e-01,
         1.84881474e-01,   1.75205275e-01,   1.65647000e-01,
         1.56220662e-01,   1.46940309e-01,   1.37820027e-01,
         1.28873934e-01,   1.20116183e-01,   1.11560959e-01,
         1.03222487e-01,   9.51150272e-02,   8.72528915e-02,
         7.96504609e-02,   7.23222205e-02,   6.52828140e-02,
         5.85471226e-02,   5.21303666e-02,   4.60482169e-02,
         4.03168798e-02,   3.49530831e-02,   2.99738486e-02,
         2.53958999e-02,   2.12345582e-02,   1.75020558e-02,
         1.42053630e-02,   1.13438569e-02,   8.90736329e-03,
         6.87516042e-03,   5.21636994e-03,   3.89180122e-03,
         2.85690535e-03,   2.06521082e-03,   1.47156065e-03,
         1.03463569e-03,   7.18524401e-04,   4.93361836e-04,
         3.35231541e-04,   2.25588058e-04,   1.50440247e-04,
         9.94770155e-05,   6.52498334e-05,   4.24697365e-05,
         2.74367658e-05,   1.75962019e-05,   1.12044893e-05,
         6.43768632e-07,   3.90023255e-07,   2.34559779e-07,
         1.40008161e-07,   8.29272726e-08,   4.87244589e-08,
         2.83845206e-08,   1.63805733e-08,   9.35038310e-09,
         5.26436221e-09,   2.90675760e-09,   1.55475537e-09,
         7.81883338e-10,   3.39857917e-10,   9.31247294e-11])
    result = SCFeqns(phi_z,chi,chi_s,sigma,navgsegments,p_i)

    assert np.allclose(result, data, atol=1e-14)

    #TODO: check float overflow handling

def SCFeqns_multi_test():
    u_jz0 = np.zeros((3,50))
    chi_jk = (1-np.eye(4))*0.10
    sigma_j = np.array((0,0,.01,0))
    phi_b_j = np.array((0,0.1,0,.9))
    n_avg_j = np.array((0,1,75,1))
    data = np.array([[ -5.52314290e-02,  -1.03134227e-01,  -1.23902379e-01,
         -1.22509546e-01,  -1.06273052e-01,  -8.37906912e-02,
         -6.14775076e-02,  -4.26557546e-02,  -2.82764492e-02,
         -1.80107679e-02,  -1.10521437e-02,  -6.53981797e-03,
         -3.73196876e-03,  -2.05342896e-03,  -1.08910584e-03,
         -5.56654539e-04,  -2.74100305e-04,  -1.29996454e-04,
         -5.93673960e-05,  -2.61011669e-05,  -1.10451439e-05,
         -4.49767739e-06,  -1.76204598e-06,  -6.63994071e-07,
         -2.40621051e-07,  -8.38353786e-08,  -2.80765437e-08,
         -9.03600415e-09,  -2.79392144e-09,  -8.29734542e-10,
         -2.36606623e-10,  -6.47656499e-11,  -1.70117891e-11,
         -4.28644351e-12,  -1.03569370e-12,  -2.39799723e-13,
         -5.33117863e-14,  -1.14174698e-14,  -2.33501732e-15,
         -4.69846300e-16,  -7.89946904e-18,  -4.46512879e-18,
         -3.83374067e-18,  -3.72284436e-18,  -3.70424847e-18,
         -3.70127350e-18,  -3.70081979e-18,  -3.70075388e-18,
         -3.70074477e-18,   3.88888889e-03],
       [ -4.80798201e-02,  -9.35171085e-02,  -1.12258255e-01,
         -1.10885581e-01,  -9.60858691e-02,  -7.56790137e-02,
         -5.54733754e-02,  -3.84583301e-02,  -2.54757702e-02,
         -1.62161669e-02,  -9.94440779e-03,  -5.88034163e-03,
         -3.35319684e-03,  -1.84357314e-03,  -9.76975949e-04,
         -4.98890083e-04,  -2.45417330e-04,  -1.16271723e-04,
         -5.30403986e-05,  -2.32918008e-05,  -9.84387025e-06,
         -4.00313149e-06,  -1.56606621e-06,  -5.89252096e-07,
         -2.13194325e-07,  -7.41538364e-08,  -2.47897057e-08,
         -7.96306979e-09,  -2.45723773e-09,  -7.28200323e-10,
         -2.07187834e-10,  -5.65785055e-11,  -1.48240256e-11,
         -3.72528658e-12,  -8.97582123e-13,  -2.07195619e-13,
         -4.59321732e-14,  -9.81671965e-15,  -2.00240574e-15,
         -4.03677261e-16,   4.69670784e-18,  -2.17197266e-18,
         -3.43474891e-18,  -3.65654152e-18,  -3.69373330e-18,
         -3.69968325e-18,  -3.70059067e-18,  -3.70072248e-18,
         -3.70074070e-18,   5.55555556e-03],
       [ -6.85647624e-02,  -1.03134227e-01,  -1.23902379e-01,
         -1.22509546e-01,  -1.06273052e-01,  -8.37906912e-02,
         -6.14775076e-02,  -4.26557546e-02,  -2.82764492e-02,
         -1.80107679e-02,  -1.10521437e-02,  -6.53981797e-03,
         -3.73196876e-03,  -2.05342896e-03,  -1.08910584e-03,
         -5.56654539e-04,  -2.74100305e-04,  -1.29996454e-04,
         -5.93673960e-05,  -2.61011669e-05,  -1.10451439e-05,
         -4.49767739e-06,  -1.76204598e-06,  -6.63994071e-07,
         -2.40621051e-07,  -8.38353786e-08,  -2.80765437e-08,
         -9.03600414e-09,  -2.79392143e-09,  -8.29734531e-10,
         -2.36606612e-10,  -6.47656388e-11,  -1.70117780e-11,
         -4.28643240e-12,  -1.03568259e-12,  -2.39788621e-13,
         -5.33006841e-14,  -1.14063675e-14,  -2.32391509e-15,
         -4.58744069e-16,   3.20276120e-18,   6.63710145e-18,
          7.26848958e-18,   7.37938588e-18,   7.39798177e-18,
          7.40095675e-18,   7.40141046e-18,   7.40147636e-18,
          7.40148547e-18,  -9.44444444e-03]])
    result=SCFeqns_multi(u_jz0,chi_jk, sigma_j, phi_b_j, n_avg_j)

    assert np.allclose(result, data, atol=1e-14)

def BasicSystem_test():
    bs = BasicSystem()
    p = (0,0,0,.1,.1,.1)
    pu = bs.unscale_parameters(p)
    ps = bs.scale_parameters(pu)
    assert p == ps

    data = np.array([[ -3.19411156e-01,  -3.89647496e-01,  -3.90270490e-01,
         -3.80437095e-01,  -3.66248523e-01,  -3.49113842e-01,
         -3.29405818e-01,  -3.07163773e-01,  -2.82352428e-01,
         -2.54947843e-01,  -2.24954033e-01,  -1.92409097e-01,
         -1.57423105e-01,  -1.20353697e-01,  -8.24002663e-02,
         -4.67742483e-02,  -1.89552925e-02,  -3.13814481e-03,
          2.20142759e-03,   2.33601299e-03,   1.27362900e-03,
          4.78180334e-04,   1.01462098e-04,  -2.28747647e-05,
         -4.03110074e-05,  -2.72163308e-05,  -1.29297425e-05,
         -4.36319481e-06,  -6.45616055e-07,   4.48961165e-07,
          5.39871059e-07,   4.77780221e-07,   6.32951664e-07,
          1.10337109e-06,   1.66086017e-06,   1.34678920e-06,
         -2.32710760e-06,  -1.44262092e-05,  -4.31263812e-05,
         -9.72718737e-05,  -1.73314694e-04,  -2.06006614e-04,
          1.04529329e-04,   1.86380529e-03,   8.63386677e-03,
          2.93905435e-02,   7.27777687e-02]])
    result = bs.from_cache((0,0,0,.1,.1,.1))

    assert np.allclose(result, data)

def VaporSwollenSystem_test():
    vs = VaporSwollenSystem()

    data = np.array([[ -3.19411156e-01,  -3.89647496e-01,  -3.90270490e-01,
         -3.80437095e-01,  -3.66248523e-01,  -3.49113842e-01,
         -3.29405818e-01,  -3.07163773e-01,  -2.82352428e-01,
         -2.54947843e-01,  -2.24954033e-01,  -1.92409097e-01,
         -1.57423105e-01,  -1.20353697e-01,  -8.24002663e-02,
         -4.67742483e-02,  -1.89552925e-02,  -3.13814481e-03,
          2.20142759e-03,   2.33601299e-03,   1.27362900e-03,
          4.78180334e-04,   1.01462098e-04,  -2.28747647e-05,
         -4.03110074e-05,  -2.72163308e-05,  -1.29297425e-05,
         -4.36319481e-06,  -6.45616055e-07,   4.48961165e-07,
          5.39871059e-07,   4.77780221e-07,   6.32951664e-07,
          1.10337109e-06,   1.66086017e-06,   1.34678920e-06,
         -2.32710760e-06,  -1.44262092e-05,  -4.31263812e-05,
         -9.72718737e-05,  -1.73314694e-04,  -2.06006614e-04,
          1.04529329e-04,   1.86380529e-03,   8.63386677e-03,
          2.93905435e-02,   7.27777687e-02]])
    result = vs.from_cache((1, -.6, 2.5, .01, .1, 75, 1))

    assert np.allclose(result, data, atol=1e-14)

def SCFsolve_test():

    #find the solution used in the previous test without an initial guess
    chi = 0.1
    chi_s = 0.05
    sigma = .1
    phi_b = 0
    navgsegments = 95.5
    pdi = 1.2
    parameters = (chi,chi_s,pdi,sigma,phi_b,navgsegments)
    bs = BasicSystem()
    data = np.array([[ -3.43014103e-01,  -4.28357067e-01,  -4.23920517e-01,
         -4.14558595e-01,  -4.03168321e-01,  -3.91006421e-01,
         -3.78517904e-01,  -3.65889210e-01,  -3.53215005e-01,
         -3.40553175e-01,  -3.27943914e-01,  -3.15417276e-01,
         -3.02996866e-01,  -2.90702002e-01,  -2.78549094e-01,
         -2.66552518e-01,  -2.54725176e-01,  -2.43078835e-01,
         -2.31624337e-01,  -2.20371724e-01,  -2.09330328e-01,
         -1.98508833e-01,  -1.87915328e-01,  -1.77557357e-01,
         -1.67441965e-01,  -1.57575750e-01,  -1.47964906e-01,
         -1.38615267e-01,  -1.29532360e-01,  -1.20721434e-01,
         -1.12187512e-01,  -1.03935419e-01,  -9.59698270e-02,
         -8.82952852e-02,  -8.09162631e-02,  -7.38371921e-02,
         -6.70625164e-02,  -6.05967560e-02,  -5.44445848e-02,
         -4.86109281e-02,  -4.31010780e-02,  -3.79208148e-02,
         -3.30765063e-02,  -2.85751267e-02,  -2.44241038e-02,
         -2.06308770e-02,  -1.72020511e-02,  -1.41420925e-02,
         -1.14516494e-02,  -9.12575419e-03,  -7.15232551e-03,
         -5.51142747e-03,  -4.17561113e-03,  -3.11138072e-03,
         -2.28150853e-03,  -1.64770430e-03,  -1.17310919e-03,
         -8.24217491e-04,  -5.72046084e-04,  -3.92576261e-04,
         -2.66624270e-04,  -1.79344774e-04,  -1.19555834e-04,
         -7.90269570e-05,  -5.18185316e-05,  -3.37164382e-05,
         -2.17746033e-05,  -1.39599829e-05,  -8.33278462e-07,
         -5.07442526e-07,  -3.06408616e-07,  -1.83272136e-07,
         -1.08394068e-07,  -6.31845181e-08,  -3.60683806e-08,
         -1.98887772e-08,  -1.02540933e-08,  -4.51295977e-09,
         -1.18629412e-09]])

    result = SCFsolve(bs.field_equations(parameters),np.zeros((1,40)))

    assert np.allclose(result, data)

    # try a very hard one using the answer as an initial guess
    chi = 1
    chi_s = .5
    parameters = (chi,chi_s,pdi,sigma,phi_b,navgsegments)

    try:
        SCFsolve(bs.field_equations(parameters),np.zeros((1,40)))
    except NoConvergence:
        pass
    else: # Belongs to try, executes if no exception is raised
        assert False, 'should not arrive here'

    data = np.array([[  3.07254929e-01,   1.41259529e-01,   1.62795764e-01,
          1.68991420e-01,   1.76513700e-01,   1.83949395e-01,
          1.91169043e-01,   1.98034330e-01,   2.04468663e-01,
          2.10498735e-01,   2.16628713e-01,   2.25451759e-01,
          2.46568079e-01,   2.60299445e-01,   1.53151751e-01,
          4.00451631e-02,   6.78029664e-03,   1.22648571e-03,
          2.88017146e-04,   8.06983334e-05,   2.42960996e-05,
          7.48556220e-06,   2.32031419e-06,   7.19743365e-07,
          2.23051957e-07,   6.90243465e-08,   2.13222654e-08,
          6.57099636e-09,   2.01620328e-09,   6.11667304e-10,
          1.78586804e-10,   4.58150217e-11]])
    result = SCFsolve(bs.field_equations(parameters),data)

    assert np.allclose(result, data)#, atol=1e-14)

def walk_test():
    sigma = .1
    phi_b = 0
    navgsegments = 95.5
    pdi = 1.2
    chi = 1
    chi_s = .5
    parameters = (chi,chi_s,pdi,sigma,phi_b,navgsegments)

    BasicSystem._cache.clear()
    bs = BasicSystem()
    data = np.array([[  3.07254929e-01,   1.41259529e-01,   1.62795764e-01,
          1.68991420e-01,   1.76513700e-01,   1.83949395e-01,
          1.91169043e-01,   1.98034330e-01,   2.04468664e-01,
          2.10498735e-01,   2.16628713e-01,   2.25451759e-01,
          2.46568079e-01,   2.60299446e-01,   1.53151751e-01,
          4.00451629e-02,   6.78029660e-03,   1.22648571e-03,
          7.19755100e-07,   2.23063672e-07,   6.90361303e-08,
          2.13339907e-08,   6.58271991e-09,   2.02809150e-09,
          6.23858968e-10,   1.91585076e-10,   5.86983833e-11,
          1.79114579e-11,   5.40519349e-12,   1.57063921e-12,
          4.01446314e-13]])
    result = bs.walk(parameters)

    assert np.allclose(result, data)

    # check that the cache is holding items
    assert bs._cache

    # check high pdi solutions converge without too many layers
    parameters = (.47,0,1.75,.1,.1,100)
    result = bs.walk(parameters)

    assert result.shape <= (1,150)

    # check vapor swollen too
    vs = VaporSwollenSystem()
    param = (1, -1.5, 2.5, .01, .1, 75, 1)
    result = vs.walk(param)
    data = np.array([[ -1.52118964e+00,  -1.38452635e+00,  -8.13458121e-01,
         -1.90503081e-01,  -2.48189018e-02,  -2.80714332e-03,
         -3.11807278e-04,  -3.46079381e-05,  -3.84675194e-06,
         -4.28062901e-07,  -4.80107894e-08,  -5.46603396e-09,
         -7.57384103e-10,  -5.07609710e-10,  -9.38686430e-11,
          4.37692587e-10,  -1.02105058e-06,  -9.42204239e-06,
         -8.69157310e-05,  -8.01458870e-04,  -7.36536215e-03,
         -6.56689505e-02,  -4.69992867e-01],
       [ -9.41579696e-01,  -8.23304003e-01,  -5.89680968e-01,
         -1.45219368e-01,  -1.91983325e-02,  -2.17836228e-03,
         -2.42050830e-04,  -2.68635618e-05,  -2.98562864e-06,
         -3.32270492e-07,  -3.72601828e-08,  -4.20722047e-09,
         -6.11468360e-10,  -3.08604173e-10,  -6.30900786e-11,
          2.50557216e-10,  -7.94180765e-07,  -7.32834618e-06,
         -6.76010388e-05,  -6.23348988e-04,  -5.72794321e-03,
         -5.10211523e-02,  -2.78862796e-01],
       [  1.73564354e+00,   1.14044803e+00,   2.18743362e-01,
          2.59693841e-02,   2.88315788e-03,   3.19408621e-04,
          3.54379267e-05,   3.93855739e-06,   4.38263064e-07,
          4.88090132e-08,   5.38444458e-09,   6.66409423e-10,
          4.60675112e-12,   7.48004028e-11,  -2.33060111e-12,
         -5.74368213e-11,   1.13509381e-07,   1.04678216e-06,
          9.65768594e-06,   8.90905622e-05,   8.21732332e-04,
          7.57004061e-03,   6.89908214e-02]])

    assert np.allclose(result, data)


def SCFsqueeze_test():

    # squeeze the easy solution substantially
    chi = 0.1
    chi_s = 0.05
    sigma = .1
    phi_b = 0
    navgsegments = 95.5
    pdi = 1.2
    layers = 65
    data = np.array([  3.65558082e-01,   3.97533333e-01,   3.95179978e-01,
         3.88757819e-01,   3.80787284e-01,   3.72130794e-01,
         3.63092959e-01,   3.53800165e-01,   3.44316370e-01,
         3.34681240e-01,   3.24923297e-01,   3.15065003e-01,
         3.05125186e-01,   2.95120440e-01,   2.85066025e-01,
         2.74976440e-01,   2.64865786e-01,   2.54747977e-01,
         2.44636853e-01,   2.34546245e-01,   2.24489996e-01,
         2.14481972e-01,   2.04536066e-01,   1.94666194e-01,
         1.84886295e-01,   1.75210336e-01,   1.65652309e-01,
         1.56226235e-01,   1.46946170e-01,   1.37826200e-01,
         1.28880447e-01,   1.20123068e-01,   1.11568257e-01,
         1.03230243e-01,   9.51233029e-02,   8.72617647e-02,
         7.96600346e-02,   7.23326302e-02,   6.52942345e-02,
         5.85597723e-02,   5.21445036e-02,   4.60641230e-02,
         4.03348257e-02,   3.49732711e-02,   2.99963349e-02,
         2.54205052e-02,   2.12607873e-02,   1.75290516e-02,
         1.42319226e-02,   1.13685232e-02,   8.92858342e-03,
         6.89147965e-03,   5.22661400e-03,   3.89520205e-03,
         2.85314433e-03,   2.05437856e-03,   1.45405351e-03,
         1.01101862e-03,   6.89388676e-04,   4.59200254e-04,
         2.96354450e-04,   1.82124633e-04,   1.02535872e-04,
         4.79564181e-05,   1.33585282e-05])
    result = SCFsqueeze(chi,chi_s,pdi,sigma,phi_b,navgsegments,layers)

    assert np.allclose(result, data)

def SCFprofile_test():

    # basically checking that numpy interp hasn't changed
    data = np.array([ 0.50131233,  0.48796218,  0.47461203,  0.46161254,  0.4540684 ,
        0.44652427,  0.43950505,  0.43630667,  0.43310828,  0.43002508,
        0.42746238,  0.42489968,  0.42236902,  0.41993892,  0.41750881,
        0.41509046,  0.41269928,  0.4103081 ,  0.40792589,  0.40555947,
        0.40319304,  0.40083606,  0.39849197,  0.39614787,  0.39381376,
        0.39149031,  0.38916687,  0.38685349,  0.38454857,  0.38224365,
        0.37994853,  0.37765983,  0.37537114,  0.37309178,  0.37081712,
        0.36854247,  0.3662766 ,  0.36401406,  0.36175152,  0.35949721,
        0.35724515,  0.35499309,  0.35274876,  0.35050584,  0.34826292,
        0.34602731,  0.34379246,  0.3415576 ,  0.33932973,  0.33710209,
        0.33487464,  0.33265359,  0.33043253,  0.32821201,  0.32599706,
        0.32378211,  0.32156802,  0.31935885,  0.31714968,  0.31494168,
        0.31273809,  0.31053451,  0.3083324 ,  0.30613431,  0.30393623,
        0.30173996,  0.2995474 ,  0.29735483,  0.29516446,  0.29297754,
        0.29079062,  0.28860633,  0.28642526,  0.28424419,  0.28206626,
        0.27989135,  0.27771644,  0.27554527,  0.27337693,  0.27120858,
        0.26904469,  0.26688341,  0.26472213,  0.26256615,  0.26041255,
        0.25825894,  0.25611165,  0.25396644,  0.25182124,  0.24968354,
        0.24754758,  0.24541162,  0.2432846 ,  0.24115888,  0.23903317,
        0.23691807,  0.23480374,  0.23268941,  0.2305877 ,  0.22848608,
        0.22638522,  0.22429782,  0.22221042,  0.22012484,  0.21805341,
        0.21598197,  0.21391366,  0.21186017,  0.20980668,  0.20775793,
        0.20572465,  0.20369136,  0.20166479,  0.19965428,  0.19764376,
        0.19564237,  0.19365754,  0.1916727 ,  0.1896999 ,  0.18774402,
        0.18578813,  0.18384778,  0.18192452,  0.18000125,  0.17809769,
        0.17621113,  0.17432458,  0.17246262,  0.17061728,  0.16877194,
        0.16695692,  0.1651577 ,  0.16335849,  0.16159617,  0.15984837,
        0.15810057,  0.15639713,  0.15470633,  0.15301553,  0.15137739,
        0.14974939,  0.14812138,  0.14655508,  0.14499572,  0.14343636,
        0.14194834,  0.14046334,  0.13897992,  0.13757467,  0.13616943,
        0.13477096,  0.13345028,  0.1321296 ,  0.13082137,  0.12958927,
        0.12835716,  0.12714346,  0.12600292,  0.12486238,  0.12374624,
        0.12269905,  0.12165186,  0.12063484,  0.11968146,  0.11872807,
        0.11781018,  0.11694968,  0.11608918,  0.11526878,  0.1144989 ,
        0.11372902,  0.11300294,  0.11232017,  0.11163739,  0.11100108,
        0.1104008 ,  0.10980052,  0.10924827,  0.10872502,  0.10820176,
        0.10772702,  0.10727468,  0.10682235,  0.10641798,  0.10603007,
        0.10564217,  0.10530078,  0.10497068,  0.10464057,  0.10435478,
        0.1040759 ,  0.10379702,  0.10355968,  0.10332568,  0.10309168,
        0.10289606,  0.10270098,  0.10250745,  0.10234579,  0.10218412,
        0.1020255 ,  0.10189227,  0.10175903,  0.10162981,  0.10152057,
        0.10141133,  0.10130667,  0.10121752,  0.10112837,  0.10104403,
        0.1009716 ,  0.10089916,  0.10083153,  0.1007729 ,  0.10071428,
        0.10066029,  0.10061301,  0.10056573,  0.10052281,  0.10048481,
        0.10044682,  0.10041282,  0.10038238,  0.10035193,  0.1003251 ,
        0.10030078,  0.10027646,  0.10025535,  0.10023598,  0.1002166 ,
        0.10020005,  0.10018465,  0.10016925,  0.10015632,  0.10014411,
        0.1001319 ,  0.10012182,  0.10011216,  0.10010251,  0.10009467,
        0.10008706,  0.10007944,  0.10007337,  0.10006737,  0.10006139,
        0.10005668,  0.10005198,  0.10004734,  0.10004365,  0.10003996,
        0.10003637,  0.10003349,  0.1000306 ,  0.10002783,  0.10002557,
        0.10002332,  0.10002118,  0.10001942,  0.10001765,  0.100016  ,
        0.10001462,  0.10001323,  0.10001195,  0.10001086,  0.10000976,
        0.10000875,  0.10000786,  0.10000698,  0.10000616,  0.10000542,
        0.10000467,  0.10000397,  0.10000331,  0.10000264,  0.1       ,
        0.1       ,  0.1       ,  0.1       ,  0.1       ,  0.1       ,
        0.1       ,  0.1       ,  0.1       ,  0.1       ,  0.1       ,
        0.1       ,  0.1       ,  0.1       ,  0.1       ,  0.1       ,
        0.1       ,  0.1       ,  0.1       ,  0.1       ,  0.1       ,
        0.1       ,  0.1       ,  0.1       ,  0.1       ,  0.1       ,
        0.1       ,  0.1       ,  0.1       ,  0.1       ,  0.1       ,
        0.1       ,  0.1       ,  0.1       ,  0.1       ,  0.1       ,
        0.1       ,  0.1       ,  0.1       ,  0.1       ,  0.1       ,
        0.1       ,  0.1       ,  0.1       ,  0.1       ,  0.1       ,
        0.1       ,  0.1       ,  0.1       ,  0.1       ,  0.1       ,
        0.1       ,  0.1       ,  0.1       ,  0.1       ,  0.1       ,
        0.1       ,  0.1       ,  0.1       ,  0.1       ,  0.1       ,
        0.1       ,  0.1       ,  0.1       ,  0.1       ,  0.1       ,
        0.1       ,  0.1       ,  0.1       ,  0.1       ,  0.1       ,
        0.1       ,  0.1       ,  0.1       ,  0.1       ,  0.1       ])
    result = SCFprofile(np.linspace(0,120,350), chi=.5, chi_s=.3, h_dry=15,
                        l_lat=1, mn=200, m_lat=1, phi_b=0.1, pdi=1.5, disp=False)

    assert np.allclose(result, data)


def benchmark():
    from time import clock
    BasicSystem._cache.clear()
    start=clock()
    bs = BasicSystem()
    p = (0,0,1,.1,0,160.52)
    bs.walk(p)
    p = (0,0,1.75,.1,0,360.52)
    bs.walk(p)
    print('Benchmark time:', clock()-start, 'seconds.')


def main():
    from time import clock
    start=clock()
    calc_g_zs_ta_test()
    calc_g_zs_free_test()
    calc_g_zs_ngts_u_test()
    calc_g_zs_ngts_test()
    calc_g_zs_ngts_test()
    BasicSystem_test()
    SCFsolve_test()
    SCFeqns_multi_test()
    walk_test()
    SCFsqueeze_test()
    SCFprofile_test()
    stop=clock()
    print('All tests passed in {:.3g} seconds!'.format(stop-start))
    benchmark()


if __name__ == '__main__':
    main()
